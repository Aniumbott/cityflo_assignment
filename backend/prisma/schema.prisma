generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Note: Prisma looks for .env in the schema directory first, then project root.
// For local dev, run prisma commands from /backend with DATABASE_URL set,
// or create backend/.env with just DATABASE_URL for prisma CLI.

enum UserRole {
  EMPLOYEE
  ACCOUNTS
  SENIOR_ACCOUNTS
}

enum InvoiceCategory {
  VENDOR_PAYMENT
  REIMBURSEMENT
}

enum InvoiceStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
  PAID
}

enum ExtractionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum AuditAction {
  SUBMITTED
  VIEWED
  EDITED
  APPROVED
  REJECTED
  MARKED_PAID
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  username     String   @unique
  passwordHash String   @map("password_hash")
  role         UserRole @default(EMPLOYEE)
  createdAt    DateTime @default(now()) @map("created_at")

  invoices      Invoice[]
  auditActions  InvoiceAction[]
  notifications Notification[]

  @@map("users")
}

model Invoice {
  id               String           @id @default(uuid())
  submittedBy      String           @map("submitted_by")
  category         InvoiceCategory
  status           InvoiceStatus    @default(PENDING_REVIEW)
  notes            String?
  filePath         String           @map("file_path")
  originalFilename String           @map("original_filename")
  extractionStatus ExtractionStatus @default(PENDING)
  isDuplicate      Boolean          @default(false) @map("is_duplicate")
  duplicateOf      String?          @map("duplicate_of")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  submitter     User            @relation(fields: [submittedBy], references: [id])
  extractedData ExtractedData?
  actions       InvoiceAction[]
  notifications Notification[]

  @@map("invoices")
}

model ExtractedData {
  id              String   @id @default(uuid())
  invoiceId       String   @unique @map("invoice_id")
  vendorName      String?  @map("vendor_name")
  invoiceNumber   String?  @map("invoice_number")
  invoiceDate     String?  @map("invoice_date")
  dueDate         String?  @map("due_date")
  subtotal        Decimal? @db.Decimal(12, 2)
  tax             Decimal? @db.Decimal(12, 2)
  grandTotal      Decimal? @map("grand_total") @db.Decimal(12, 2)
  paymentTerms    String?  @map("payment_terms")
  bankDetails     String?  @map("bank_details")
  rawText         String?  @map("raw_text")
  confidenceScores Json?   @map("confidence_scores")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  invoice   Invoice    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  lineItems LineItem[]

  @@map("extracted_data")
}

model LineItem {
  id              String   @id @default(uuid())
  extractedDataId String   @map("extracted_data_id")
  description     String?
  quantity        Decimal? @db.Decimal(10, 3)
  unitPrice       Decimal? @map("unit_price") @db.Decimal(12, 2)
  total           Decimal? @db.Decimal(12, 2)

  extractedData ExtractedData @relation(fields: [extractedDataId], references: [id], onDelete: Cascade)

  @@map("line_items")
}

model InvoiceAction {
  id        String      @id @default(uuid())
  invoiceId String      @map("invoice_id")
  userId    String      @map("user_id")
  action    AuditAction
  comment   String?
  createdAt DateTime    @default(now()) @map("created_at")

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@map("invoice_actions")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  invoiceId String?  @map("invoice_id")
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id])
  invoice Invoice? @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("notifications")
}
